<link rel="stylesheet" href="/static/css/ol.css" type="text/css">
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen" />

<script src="/static/js/ol.js" type="text/javascript"></script>
<script src="/static/js/vendor/jquery.serializeJSON.min.js" type="text/javascript"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/openlayers/2.13.1/OpenLayers.js"></script>
<!-- script src="http://maps.google.com/maps/api/js?sensor=false"></script -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<script src="https://code.jquery.com/ui/1.8.1/jquery-ui.min.js" type="text/javascript"></script>

<style type="text/css">
    .ui-autocomplete {
    background-color: white;
    width: 300px;
    border: 1px solid #cfcfcf;
    list-style-type: none;
    padding-left: 0px;
    }
    label {
        font-size:16px;
    }
    #map_canvas label {
        width: auto;
        display: inline;
    }
    #map_canvas img {
        max-width: none;
    }
    .affix {
        width: inherit;
        height: 0px;
    }
  
    .affix-bottom {
        top: auto !important;
        position: fixed;
        bottom: 240px;
    }
    
    #imgContainer {
        height: 390px;
        width: 600px;
    } 
#map {
height:400px;
width:100%;
}
</style>

<div style="display:none;margin-top:15px; height:500px;" id="oldbrowser" class="row">
    <!-- Success and Error Messages for the user -->
    <div  class="col-md-8 col-md-offset-1 alert alert-info">
        <h2>
            Browser problems!
        </h2>
        <p>
            Sorry, but your browser does not support the current application. 
            If you want to contribute, please, upgrade to a modern web browser 
            like the open source and free alternative 
            <a href="http://www.mozilla.org/en-US/firefox/new/">Firefox</a> or 
            <a href="https://www.google.com/intl/en/chrome/browser/">Chrome</a>.
        </p>
    </div>
</div> 
<!-- End of Row -->

<div style="margin-top:15px;">
    <div id="success" class="alert alert-success" style="display:none;">
        <strong>Well done!</strong> You have successfully submitted your task. Here is another to try if you wish!
    </div>
    <div id="loading" class="alert alert-info" style="display:none;">
        <img src="/static/img/loading.gif">Loading next task...
    </div>
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
        <strong>The task has been completed!</strong> Thanks a lot!
    </div>
    <div id="finish" class="alert alert-success" style="display:none;">
        <h2>
            Congratulations!
        </h2> 
        <p>
            You have participated in <strong>all</strong> available tasks! Thank you for your interest and help.
        </p>
        <br/>
        <img src="https://crowdfunded.micropasts.org/assets/logo-head.png" width="200" height="200"/>
        <div class="alert-actions">
            <a class="btn-default btn" href="/">Go back</a>
            <a class="btn-default btn" href="/app">or, Check other applications</a>
        </div>
    </div>

    <div id="error" class="alert alert-error" style="display:none;">
        <a class="close">X.</a>
        <strong>Error!</strong> Something went wrong, please contact the site 
        administrators via the forum, Twitter, email or our Facebook page.
    </div>
</div> <!-- End Success and Error Messages for the user -->


<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->

<!-- Start Skeleton Row-->
<div class="row skeleton"> 

        <h1 id="start">
            Please transcribe into Greek this register (and optionally translate it into English)
        </h1> 
    
    <!-- The question will be loaded here -->
    
    <span class="label label-info">Note</span> You can use your mouse wheel track-pad to zoom in/out the picture, as well as drag & drop to navigate in the document.

</div>

<!-- Start of Question and Submission DIV (column) -->
<div class="row skeleton">

    <div id="questions" class="col-md-4">
        <!-- If the user clicks this button, the saved answer will be value="yes"-->
        <form id="trans" role="form">        
            <!-- Transcription --> 
            <div class="form-group">
                <label class="control-label" for="transcription">Page Transcription</label>
                <textarea class="form-control" rows="10" name="transcription" placeholder="Please transcribed the page as accurately as possible."></textarea>
            </div>
            <!-- Translation --> 
            <div class="form-group">
                <label class="control-label" for="translation">Page Translation</label>
                <textarea class="form-control" rows="10" name="translation" placeholder="Please translate the text to English."></textarea>
            </div>
            <!-- Transcriber's comments --> 
            <div class="form-group">
                <label class="control-label" for="other">Contributors's Comments</label>
                <textarea class="form-control" rows="5" name="other" placeholder="Add here your comments, if you have any."></textarea>
            </div>    
        </form>
        <button class="btn btn-info btn-answer" value='Yes'>Submit the task</button>
            
        <!-- Feedback items for the user -->
        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
        <p>
        You have completed: <span id="done" class="label label-info"></span> tasks from
        <!-- Progress bar for the user -->
        <span id="total" class="label label-inverse"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="progress-bar" role="progressbar" style="width: 0%;"></div>
        </div>
    <!-- End of feedback row -->

    </div>
    <!-- End of Question and Submission DIV (column) -->
    
    <!-- The column holding the open layers div -->    
    <div id="photo-link" class="col-md-7 col-md-offset-1">
        <!-- Start of Photo DIV (column) -->
        <div id="imgHolder" data-spy="affix" data-offset-top="1" data-offset-bottom="500">
            <div class="btn-group">
                <a class="btn btn-info btn-sm" href="#" data-toggle="modal" data-target="#myModal"><i class="glyphicon glyphicon-eye-open"></i> Tutorial</a>
                <a class="btn btn-info btn-sm" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="http://community.micropasts.org/category/crowdsourcing-support"><i class="glyphicon glyphicon-book"></i> Community Help</a>
                <a id="raw" href="" class="btn btn-sm btn-info fancybox"><i class="glyphicon glyphicon-picture"></i> Overlay</a>
                <a id="flickr" rel="tooltip" target="_blank" data-toggle="tooltip" data-placement="top" title="Opens in a new window" href="https://www.flickr.com/photos/130806234@N04/sets/72157649954901537/" class="btn btn-sm btn-info"><i class="icon icon-flickr"></i> View on flickr</a>
                <a id="down" rel="tooltip" data-toggle="tooltip" data-placement="top" title="Only works for compliant browsers" download="" href="" class="btn btn-sm btn-info" ><i class="glyphicon glyphicon-download"></i> Download</a>
            </div>
            <!-- The container for the zoomer --> 
            <div id="imgContainer"></div>
            <div id="taskImg"></div>
        </div><!-- End of Photo DIV (columnt) -->
    </div>

</div><!-- End of Skeleton Row -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
    <!-- Modal header --> 
        <div class="modal-header">
                <h3 class="lead">Tutorial. Transcribing a Greek parish church register</h3>
            </div>
        <!-- stepped modal body -->
             <div id="0" class="modal-body" style="display:none">
                <p>
                This application has the primary objective of transcribing a 19th century handwritten Greek register from a parish church transcription. Most of the transcription is in Greek and is challenging because of its use of abbreviations and old-fashioned idiom. 
                It is not necessarily a text that most modern Greek speakers will find easy to decipher, but we are hoping that there are some who can! The task is made more difficult still by the occasional presence of bits of text written in Italian and English which we would also like to transcribe where possible (but you can leave these out if you prefer). 
                Finally, the contributor is invited to add an approximate English translation of the transcribed text if they wish (although this is not is also not compulsory). 
                The platform will present a scanned page loaded directly from the digital repository of the Greek State Archives (you will notice the watermark of the latter stamped into the page and all terms and conditions for use of this scan follow those of the Greek State Archives).
            	Once the image has been loaded, you will be asked to transcribe (and optionally translate) the contents of each page. 
            	An example portion of a register page is provided below:
                </p>
                <img src="http://micropasts.org/wp-content/uploads/2015/01/POW_Sample_Tutorial.png" class="img-polaroid" alt="An example of one of the Bronze Age Index cards" width="75%" height="75%"/>
            </div>
            <div id="1" class="modal-body" style="display:none">
                <p>
                Some further bits of guidance as you transcribe:
                <ul>    
                    <li>Please transcribe the text as accurately as possible, following the original letter/word case, lines and punctuation.</li> 
                    <li>Try to enter all the text that you see, in the right order.</li>
                    <li>If you need to skip text because it is not recogniseable, use the symbol [...] including the square brackets, to signal this omission. If you skip more than one line, repeat this symbol per line.</li>     
                    <li>If you want to pass any comments on to us, in the middle of the text, place them in square brackets. For example, if a word is hard to decipher, do your best to identify it and then you might put [uncertain, alternative: 'Ποταμού']</li>
                    <li>The application accepts accented Greek characters (UTF-8, including polytonic), so feel free to use these.</li>
                </ul>            
                </p> 
            </div>
            <div id="2" class="modal-body" style="display:none">
                <p>
                The box for adding an English translation is wholly optional because our priority is on producing a good Greek transcription. However, if you are able to offer an approximate English translation, then please bear in mind the following points:
                <ul>    
                    <li>The structure of the translation should roughly follow that of the transcription, so use the same symbols to indicate omissions. </li>
                    <li>As with the transcription, if a word is hard to decipher, do your best to identify it and make a comment to note the problem.</li>    
                </ul>            
                </p>
            	<p>
                During the transcription and translation, you can always return to this tutorial via the "Tutorial" button.
                </p>
                <p>
                To find out how the project is progressing, suggest changes to this application or
                propose new research ideas based what you have transcribed and translated, please have a look at our <a href="http://community.micropasts.org" title="Community forum">community forum</a>.
                </p>
            </div>
        <!-- End of stepped modal body -->

        <!-- Modal footer -->
            <div class="modal-footer">
                <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
                <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
                <button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none"><i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
            </div>
    </div>
  </div>
</div>
<!-- Modal end --> 

<script>
var step = -1;
function showStep(action) {
    $("#" + step).hide();
    if (action == 'next') {
        step = step + 1;
    }
    if (action == 'prev') {
        step = step - 1;
    }
    if (step == 0) {
        $("#prevBtn").hide();
    }
    else {
        $("#prevBtn").show();
    }
    if (step == 2) {
        $("#nextBtn").hide();
        $("#startContrib").show();
    }
    $("#" + step).show();
}

showStep('next');
$("#modal").modal('show');
</script>

<!-- The modernizer script --> 
<script>
// Quick fix for IE8
Modernizr.load({
    test: window.JSON,
    nope: '/static/js/vendor/json2.min.js'
});
</script>

<!-- The main pybossa functions --> 
<script>
function loadUserProgress() {
    pybossa.userProgress('GreekBMD1').done(function(data){
        console.log(data);
        console.log("Total answers done for user: " + data.done);
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'});
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}
</script>

<script>
pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        var img = $('<img />');
        var div_map = $('<div/>');
        
        div_map.css("height", "390px");
        div_map.css("width", "600px");
        div_map.css("background", "#000");

        var copyright = "&copy; <a href='" + task.info.link + "'>Γενικά Αρχεία του Κράτους (Γ.Α.Κ.) 2015</a>";

        var extent = new OpenLayers.Bounds();
        extent.extend(new OpenLayers.LonLat(1.758939,58.672231).transform(new OpenLayers.Projection("EPSG:4326"),
        new OpenLayers.Projection('EPSG:900913')));
        
        extent.extend(new OpenLayers.LonLat(-6.99745,49.96112).transform(new OpenLayers.Projection("EPSG:4326"),
        new OpenLayers.Projection('EPSG:900913')));

        $("#imgContainer").append(div_map);
        div_map.attr("id", "img_" + task.id);

        task.pixelProjection = new ol.proj.Projection({
          code: 'pixel',
          units: 'pixels',
          extent: [0, 0, 1021, 1560]
        });

        task.map_img = new ol.Map({
            //interactions: ol.interaction.defaults().extend([task.select, task.modify]),
            layers: [
            new ol.layer.Image({
              source: new ol.source.ImageStatic({
                attributions: [
                  new ol.Attribution({
                    html: copyright
                  })
                ],
                url: task.info.url_b,
                imageSize: [1021, 1560],
                projection: task.pixelProjection,
                imageExtent: task.pixelProjection.getExtent()
              })
            })
          ],
          renderer: 'canvas',
          target: 'img_' + task.id,
          view: new ol.View({
            projection: task.pixelProjection,
            center: ol.extent.getCenter(task.pixelProjection.getExtent()),
            zoom: 1.0
          })
        });
        div_map.css("display", "none");

        // load image from flickr
        var img = $('<img />');
        img.attr("id", "img_task_" + task.id);
        img.load(function() {
            // continue as soon as the image is loaded
            deferred.resolve(task);
        });
        img.attr('src', task.info.url_b);
        img.attr('width', '600px');
        img.attr('height', '390px');
        img.addClass('img-polaroid');
        img.css("cursor", "zoom-in");
        task.info.image = img;

    }  else {
        deferred.resolve(task);
    }
});
</script>

<script>
pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        $(':input','#trans')
           .not(':button, :submit, :reset, :hidden, :radio')
           .val('')
           .removeAttr('checked')
           .removeAttr('selected');
      
      	$("a#raw").attr("href", task.info.url_b);
	$("a#flickr").attr("href", task.info.link + '/sizes/k/');
	$("a#down").attr("download", task.id);
	$("a#down").attr("href", task.info.url_b );
        $(".fancybox").fancybox();
        $("[rel=tooltip]").tooltip();
        $("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $("#img_" + task.id).show();

        $('.btn-answer').off('click').on('click', function(evt) {
            evt.preventDefault();
            var answer = $(evt.target).attr("value");
            if (typeof answer !== 'undefined') {
                console.log(answer);
                if (answer === 'search') {
                    $("#searching").show();
                    search(task, $("#toSearch").val(), 15);
                } else {
                    task.answer = $("#trans").serializeJSON();
                    console.log(task.answer);
                    pybossa.saveTask(task.id, task.answer).done(function() {
                        $("#img_" + task.id).hide();
                        $("html, body").animate({ scrollTop: 0 }, "slow");
                        $("#success").fadeIn(500).fadeOut(5500);
                        $("#loading").fadeIn(500).fadeOut(1000);
                        deferred.resolve();
                    });
                    $("#loading").fadeIn(500);
                    
                }
            } else {
                console.log(answer);
                console.log(typeof(answer));
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});

if(Modernizr.borderradius) {
    pybossa.run('GreekBMD1');
}
else {
    $(".skeleton").hide();
    $("#oldbrowser").show();
}

$(window).off('.affix');
$("#imgHolder")
    .removeClass("affix affix-top affix-bottom")
    .removeData("bs.affix");
</script>
